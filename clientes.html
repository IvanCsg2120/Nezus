<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gestión de Clientes — Nexus Pro</title>
  <link rel="stylesheet" href="css/clientes.css" />
  <link rel="stylesheet" href="css/dashboard.css" />
  <!-- Incluir también el CSS del dashboard si es necesario -->
</head>
<body>
  <!-- Estructura del Dashboard -->
  <div class="dashboard-layout">
    
    <!-- Sidebar (copiar del dashboard principal) -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <i class="fas fa-code"></i>
        </div>
        <div class="sidebar-title">
          <h2>Nexus Pro</h2>
          <p>Freelance System</p>
        </div>
      </div>

      <div class="sidebar-user">
        <div class="user-avatar-sidebar">
          <i class="fas fa-user"></i>
        </div>
        <div class="user-info-sidebar">
          <h3 id="userName">Usuario</h3>
          <p>Administrador</p>
        </div>
        <button class="add-btn">
          <i class="fas fa-plus"></i>
        </button>
      </div>

      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Principal</div>
          <a href="dashboard.html" class="nav-item">
            <i class="fas fa-home"></i>
            <span>Dashboard</span>
          </a>
          <a href="clientes.html" class="nav-item active">
            <i class="fas fa-users"></i>
            <span>Clientes</span>
            <span class="nav-badge" id="clientesCount">0</span>
          </a>
          <a href="proyectos.html" class="nav-item">
            <i class="fas fa-briefcase"></i>
            <span>Proyectos</span>
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Herramientas</div>
          <a href="cotizaciones.html" class="nav-item">
            <i class="fas fa-file-invoice-dollar"></i>
            <span>Cotizaciones</span>
          </a>
          <a href="facturas.html" class="nav-item">
            <i class="fas fa-receipt"></i>
            <span>Facturación</span>
          </a>
          <a href="reportes.html" class="nav-item">
            <i class="fas fa-chart-bar"></i>
            <span>Reportes</span>
          </a>
        </div>
      </nav>

      <div class="sidebar-footer">
        <div class="version-info">
          <div class="version-icon">
            <i class="fas fa-rocket"></i>
          </div>
          <div class="version-text">
            <h4>Nexus Pro v2.1</h4>
            <p>Sistema actualizado</p>
          </div>
          <button class="version-menu">
            <i class="fas fa-ellipsis-v"></i>
          </button>
        </div>
      </div>
    </aside>

    <!-- Contenido Principal -->
    <main class="main-wrapper">
      <!-- Topbar -->
      <header class="content-topbar">
        <div class="topbar-left">
          <button class="menu-toggle">
            <i class="fas fa-bars"></i>
          </button>
          <div class="search-bar">
            <i class="fas fa-search"></i>
            <input type="text" placeholder="Buscar en el sistema...">
          </div>
        </div>
        <div class="topbar-right">
          <div class="topbar-actions">
            <button class="action-btn">
              <i class="fas fa-bell"></i>
              <span class="action-badge">3</span>
            </button>
            <button class="action-btn">
              <i class="fas fa-envelope"></i>
              <span class="action-badge">5</span>
            </button>
          </div>
          <button class="logout-btn" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i>
            Salir
          </button>
        </div>
      </header>

      <!-- Contenido de Clientes -->
      <div class="dashboard-content">
        <div class="clientes-container">
          
          <!-- Header de Clientes -->
          <div class="clientes-header">
            <div class="clientes-title">
              <h1>Gestión de Clientes</h1>
              <p>Administra y gestiona todos los clientes del sistema</p>
            </div>
            <div class="clientes-actions">
              <button class="btn btn-primary" onclick="showAddForm()">
                <i class="fas fa-plus"></i>
                Nuevo Cliente
              </button>
              <button class="btn btn-secondary" onclick="exportClientes()">
                <i class="fas fa-download"></i>
                Exportar
              </button>
            </div>
          </div>

          <!-- Tarjeta de Clientes -->
          <div class="clientes-card">
            
            <!-- Barra de Búsqueda y Filtros -->
            <div class="search-filters">
              <div class="search-box">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="searchInput" placeholder="Buscar clientes por nombre, email o teléfono...">
              </div>
              <div class="filter-group">
                <select class="filter-select" id="filterStatus">
                  <option value="">Todos los estados</option>
                  <option value="active">Activos</option>
                  <option value="inactive">Inactivos</option>
                </select>
                <select class="filter-select" id="filterDate">
                  <option value="">Todo el tiempo</option>
                  <option value="last30">Últimos 30 días</option>
                  <option value="last90">Últimos 90 días</option>
                </select>
              </div>
            </div>

            <!-- Tabla de Clientes -->
            <div class="clientes-table-container">
              <div class="table-header">
                <h3>Lista de Clientes</h3>
                <div class="table-stats">
                  <span class="stat-badge" id="totalClientes">Total: 0</span>
                  <span class="stat-badge" id="activeClientes">Activos: 0</span>
                </div>
              </div>
              
              <div class="table-wrapper">
                <table class="clientes-table">
                  <thead>
                    <tr>
                      <th>Nombre</th>
                      <th>Email</th>
                      <th>Teléfono</th>
                      <th>Fecha Registro</th>
                      <th>Estado</th>
                      <th>Acciones</th>
                    </tr>
                  </thead>
                  <tbody id="clientesTableBody">
                    <!-- Los clientes se cargarán aquí dinámicamente -->
                  </tbody>
                </table>
              </div>
            </div>

          </div>

        </div>
      </div>
    </main>
  </div>

  <!-- Modal para Agregar/Editar Cliente -->
  <div id="clienteModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">Agregar Nuevo Cliente</h3>
        <button class="close-modal" onclick="closeModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <form id="clienteForm" class="clientes-form">
        <input type="hidden" id="clienteId">
        
        <div class="form-grid">
          <div class="form-group">
            <label for="clienteNombre">Nombre completo *</label>
            <input type="text" id="clienteNombre" required placeholder="Ej: Juan Pérez">
          </div>
          
          <div class="form-group">
            <label for="clienteEmail">Email *</label>
            <input type="email" id="clienteEmail" required placeholder="ejemplo@dominio.com">
          </div>
          
          <div class="form-group">
            <label for="clienteTelefono">Teléfono</label>
            <input type="tel" id="clienteTelefono" placeholder="6000-0000">
          </div>
          
          <div class="form-group">
            <label for="clienteFecha">Fecha de registro</label>
            <input type="date" id="clienteFecha" required>
          </div>
        </div>
        
        <div class="form-actions">
          <button type="button" class="btn btn-ghost" onclick="closeModal()">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar Cliente</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Container para notificaciones Toast -->
  <div id="toastContainer" class="toast-container"></div>

  <script>
// Configuración de la base de datos
const DB_PREFIX = 'FreelancerDB_';
const CLIENTES_KEY = 'clientes';
const USERS_KEY = 'users';

// Utilidades
window.getAll = function(key){ 
    try{ 
        const data = localStorage.getItem(`${DB_PREFIX}${key}`) || '[]';
        return JSON.parse(data); 
    } catch(e){ return []; }
};

window.saveAll = function(key, arr){ 
    localStorage.setItem(`${DB_PREFIX}${key}`, JSON.stringify(arr)); 
};

window.nextId = function(entity){ 
    const k=`${DB_PREFIX}__id_${entity}`; 
    let v=parseInt(localStorage.getItem(k)||'0',10); 
    v++; 
    localStorage.setItem(k,String(v)); 
    return v; 
};

// Sincronizar usuarios como clientes
function syncUsersToClients() {
    const users = getAll(USERS_KEY);
    const clientes = getAll(CLIENTES_KEY);
    
    users.forEach(user => {
        // Verificar si el usuario ya existe como cliente
        const clienteExists = clientes.some(cliente => 
            cliente.email && cliente.email.toLowerCase() === user.email.toLowerCase()
        );
        
        if (!clienteExists && user.email) {
            // Crear cliente a partir del usuario
            const nuevoCliente = {
                id: nextId(CLIENTES_KEY),
                nombre: user.nombre,
                email: user.email,
                telefono: user.telefono || '',
                fecha_registro: user.fecha_registro || new Date().toISOString().split('T')[0],
                estado: 'active',
                cedula: user.cedula || '',
                tipo: 'usuario_registrado'
            };
            
            clientes.push(nuevoCliente);
            console.log(`Cliente sincronizado: ${user.nombre}`);
        }
    });
    
    saveAll(CLIENTES_KEY, clientes);
}

// Mostrar notificación Toast
function showToast(message, type = 'success') {
    const toastContainer = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `
        <div class="toast-icon">${type === 'success' ? '✓' : '!'}</div>
        <div class="toast-message">${message}</div>
    `;
    
    toastContainer.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 4000);
}

// Cargar y mostrar clientes
function loadClientes() {
    // Primero sincronizar usuarios existentes
    syncUsersToClients();
    
    const clientes = getAll(CLIENTES_KEY);
    const tbody = document.getElementById('clientesTableBody');
    const totalClientes = document.getElementById('totalClientes');
    const activeClientes = document.getElementById('activeClientes');
    const clientesCount = document.getElementById('clientesCount');
    
    // Actualizar estadísticas
    const activeCount = clientes.filter(c => c.estado === 'active').length;
    totalClientes.textContent = `Total: ${clientes.length}`;
    activeClientes.textContent = `Activos: ${activeCount}`;
    clientesCount.textContent = clientes.length;
    
    // Renderizar tabla
    tbody.innerHTML = '';
    
    if (clientes.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" style="text-align: center; padding: 3rem; color: var(--stone);">
                    <i class="fas fa-users" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>
                    <p>No hay clientes registrados</p>
                    <button class="btn btn-primary" onclick="showAddForm()" style="margin-top: 1rem;">
                        <i class="fas fa-plus"></i>
                        Agregar Primer Cliente
                    </button>
                </td>
            </tr>
        `;
        return;
    }
    
    clientes.forEach(cliente => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <div class="cliente-avatar" style="width: 36px; height: 36px; font-size: 14px;">
                        ${cliente.nombre.charAt(0).toUpperCase()}
                    </div>
                    <strong>${escapeHTML(cliente.nombre)}</strong>
                </div>
            </td>
            <td>${escapeHTML(cliente.email)}</td>
            <td>${escapeHTML(cliente.telefono || 'N/A')}</td>
            <td>${escapeHTML(cliente.fecha_registro)}</td>
            <td>
                <span class="status-badge ${cliente.estado === 'active' ? 'status-active' : 'status-inactive'}">
                    ${cliente.estado === 'active' ? 'Activo' : 'Inactivo'}
                </span>
            </td>
            <td>
                <div class="actions-cell">
                    <button class="action-btn edit-btn" onclick="editCliente(${cliente.id})" title="Editar">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="action-btn delete-btn" onclick="deleteCliente(${cliente.id})" title="Eliminar">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// Funciones del modal
function showAddForm() {
    document.getElementById('modalTitle').textContent = 'Agregar Nuevo Cliente';
    document.getElementById('clienteForm').reset();
    document.getElementById('clienteId').value = '';
    document.getElementById('clienteFecha').value = new Date().toISOString().split('T')[0];
    document.getElementById('clienteModal').style.display = 'flex';
}

function editCliente(id) {
    const clientes = getAll(CLIENTES_KEY);
    const cliente = clientes.find(c => c.id == id);
    
    if (cliente) {
        document.getElementById('modalTitle').textContent = 'Editar Cliente';
        document.getElementById('clienteId').value = cliente.id;
        document.getElementById('clienteNombre').value = cliente.nombre;
        document.getElementById('clienteEmail').value = cliente.email;
        document.getElementById('clienteTelefono').value = cliente.telefono || '';
        document.getElementById('clienteFecha').value = cliente.fecha_registro;
        document.getElementById('clienteModal').style.display = 'flex';
    }
}

function closeModal() {
    document.getElementById('clienteModal').style.display = 'none';
}

// Manejar envío del formulario
document.getElementById('clienteForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const id = document.getElementById('clienteId').value;
    const nombre = document.getElementById('clienteNombre').value.trim();
    const email = document.getElementById('clienteEmail').value.trim().toLowerCase();
    const telefono = document.getElementById('clienteTelefono').value.trim();
    const fecha = document.getElementById('clienteFecha').value;
    
    // Validaciones
    if (nombre.length < 3) {
        showToast('El nombre debe tener al menos 3 caracteres', 'error');
        return;
    }
    
    if (!isValidEmail(email)) {
        showToast('Email inválido', 'error');
        return;
    }
    
    const clientes = getAll(CLIENTES_KEY);
    
    if (!id) {
        // Crear nuevo cliente
        if (clientes.some(c => c.email && c.email.toLowerCase() === email)) {
            showToast('Ya existe un cliente con ese email', 'error');
            return;
        }
        
        const nuevoCliente = {
            id: nextId(CLIENTES_KEY),
            nombre: nombre,
            email: email,
            telefono: telefono,
            fecha_registro: fecha,
            estado: 'active',
            tipo: 'manual'
        };
        
        clientes.push(nuevoCliente);
        saveAll(CLIENTES_KEY, clientes);
        showToast('Cliente creado exitosamente');
        
    } else {
        // Editar cliente existente
        const index = clientes.findIndex(c => c.id == id);
        if (index !== -1) {
            // Verificar duplicado de email
            if (clientes.some((c, i) => i !== index && c.email && c.email.toLowerCase() === email)) {
                showToast('Otro cliente ya usa ese email', 'error');
                return;
            }
            
            clientes[index] = {
                ...clientes[index],
                nombre: nombre,
                email: email,
                telefono: telefono,
                fecha_registro: fecha
            };
            
            saveAll(CLIENTES_KEY, clientes);
            showToast('Cliente actualizado exitosamente');
        }
    }
    
    closeModal();
    loadClientes();
});

// Eliminar cliente
function deleteCliente(id) {
    if (!confirm('¿Estás seguro de que quieres eliminar este cliente?')) {
        return;
    }
    
    const clientes = getAll(CLIENTES_KEY).filter(c => c.id != id);
    saveAll(CLIENTES_KEY, clientes);
    showToast('Cliente eliminado exitosamente');
    loadClientes();
}

// Exportar clientes
function exportClientes() {
    const clientes = getAll(CLIENTES_KEY);
    const csv = 'Nombre,Email,Telefono,Fecha Registro,Estado\n' +
        clientes.map(c => 
            `"${c.nombre}","${c.email}","${c.telefono || ''}","${c.fecha_registro}","${c.estado}"`
        ).join('\n');
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `clientes_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    URL.revokeObjectURL(url);
    
    showToast('Clientes exportados exitosamente');
}

// Funciones de utilidad
function escapeHTML(str) {
    if (str == null) return '';
    return String(str).replace(/[&<>"']/g, c => 
        ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]
    );
}

function isValidEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

function logout() {
    if (confirm('¿Estás seguro de que quieres cerrar sesión?')) {
        localStorage.removeItem('currentUser');
        window.location.href = 'index.html';
    }
}

// Inicialización
document.addEventListener('DOMContentLoaded', function() {
    loadClientes();
    
    // Configurar búsqueda en tiempo real
    document.getElementById('searchInput').addEventListener('input', function(e) {
        // Implementar búsqueda en tiempo real aquí
        console.log('Buscando:', e.target.value);
    });
    
    // Cargar información del usuario actual
    const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
    if (currentUser.nombre) {
        document.getElementById('userName').textContent = currentUser.nombre;
    }
});

// Manejar el toggle del sidebar en móviles
document.querySelector('.menu-toggle').addEventListener('click', function() {
    document.querySelector('.sidebar').classList.toggle('active');
});
  </script>

  <!-- Font Awesome para iconos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</body>
</html>